{% extends 'base.html' %}

{% block content %}

<div class="row mt-4">
    <div class="col-12">
        
        <!-- Reklamáció lista kártya -->
        <div class="card shadow-sm border-0 rounded-4">
            <div class="card-body p-4">

                <!-- Fejléc + Új reklamáció gomb -->
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-3">
                    <h3 class="mb-0 fw-bold text-gray-800">Reklamációk listája</h3>
                    <a href="{{ url_for('uj_reklamacio') }}" class="btn btn-primary shadow-sm">
                        <i class="bi bi-plus-lg me-2"></i> Új felvétel
                    </a>
                </div>

                <!-- Reklamációk táblázata -->
                <div class="table-responsive" style="overflow-x: hidden;"> 
                    <table id="reklamaciokTable" class="table table-hover align-middle w-100" style="width:100%">
                        <thead class="table-light">
                            <tr>

                                <!-- Fő oszlopok -->
                                <th>ID</th>
                                <th>Dátum</th>
                                <th>Vevő</th>
                                <th>Termék</th>
                                <th>Hiba</th>
                                <th>Menny.</th>
                                <th>Státusz</th>
                                <th class="text-end">Műveletek</th>
                                
                                <!-- Reszponzív nézetben lenyíló (rejtett) oszlopok -->
                                <th class="none">Rekl. szám</th>
                                <th class="none">Üzemegység</th>
                                <th class="none">Visszáru</th>
                                <th class="none">Kiszállítás</th>
                                <th class="none">Költség</th>
                                <th class="none">Rögzítette</th>
                            </tr>
                        </thead>
                        <tbody>

                            <!-- Backendről érkező reklamáció lista bejárása-->
                            {% for r in rekl %}
                            <tr>
                                <td class="fw-bold text-secondary">#{{ r.id }}</td>
                                <td>{{ r.complaint_date.strftime('%Y-%m-%d') if r.complaint_date else '-' }}</td>
                                <td class="fw-medium">{{ r.customer.display_name }}</td>
                                <td>
                                    <div class="d-flex flex-column" style="line-height: 1.2;">
                                        <span>{{ r.product.display_name }}</span>
                                        <small class="text-muted" style="font-size: 0.75rem;">{{ r.product_identifier }}</small>
                                    </div>
                                </td>
                                <td>{{ r.defect_type.display_name }}</td>
                                <td class="fw-bold">{{ r.quantity }}</td>
                                
                                <td>
                                    {% if r.status.name == 'folyamatban' %}
                                        <span class="badge bg-warning text-dark px-2 py-1" style="font-size: 0.85rem;">Folyamatban</span>
                                    {% elif r.status.name == 'elfogadva' %}
                                        <span class="badge bg-success px-2 py-1" style="font-size: 0.85rem;">Elfogadva</span>
                                    {% elif r.status.name == 'visszautasítva' %}
                                        <span class="badge bg-danger px-2 py-1" style="font-size: 0.85rem;">Elutasítva</span>
                                    {% else %}
                                        <span class="badge bg-secondary px-2 py-1" style="font-size: 0.85rem;">{{ r.status.name }}</span>
                                    {% endif %}
                                </td>

                                <!-- Műveleti gombok -->
                                <td class="text-end text-nowrap">
                                    <a href="{{ url_for('modosit_reklamacio', reklamacio_id=r.id) }}" class="btn btn-sm btn-outline-primary shadow-sm" title="Módosítás">
                                        <i class="bi bi-pencil-square"></i>
                                    </a>
                                    <a href="{{ url_for('torol_reklamacio', reklamacio_id=r.id) }}" class="btn btn-sm btn-outline-danger shadow-sm ms-1" title="Törlés">
                                        <i class="bi bi-trash"></i>
                                    </a>
                                </td>

                                <!-- Részletes (lenyíló) adatok -->
                                <td>{{ r.complaint_number }}</td>
                                <td>{{ r.department.display_name }}</td>
                                <td>
                                    {% if r.requires_return %}
                                        <span class="text-danger fw-bold"><i class="bi bi-check-circle-fill"></i> Igen</span>
                                    {% else %}
                                        <span class="text-secondary"><i class="bi bi-x-circle"></i> Nem</span>
                                    {% endif %}
                                </td>
                                <td>{{ r.shipping_date.strftime('%Y-%m-%d') if r.shipping_date else '-' }}</td>
                                <td class="font-monospace fw-bold">{{ "{:,}".format(r.total_cost or 0).replace(",", " ") }} Ft</td>
                                <td>{{ r.user.surname }} {{ r.user.forename }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

            </div>
        </div>

    </div>
</div>

{% endblock content %}

{% block scripts %}
    {{ super() }}

    <script>
        $(document).ready(function() {

            // --- Reklamációk DataTable inicializálása ---
            var table = $('#reklamaciokTable').DataTable({
                responsive: true,
                language: {
                    url: "https://cdn.datatables.net/plug-ins/1.13.7/i18n/hu.json"
                },
                order: [[ 1, "desc" ]],
                columnDefs: [
                    { targets: 7, orderable: false, searchable: false },
                    
                    // --- Reszponzív prioritások ---
                    { responsivePriority: 1, targets: 0 }, // ID mindig látszik
                    { responsivePriority: 2, targets: -1 }, // Rejtett oszlopok (Részletek)
                    { responsivePriority: 3, targets: 7 }, // Műveletek gombok
                    
                    // --- Rejtett oszlopok ---
                    { targets: [8, 9, 10, 11, 12, 13], className: 'none' } 
                ]
            });

            // --- Reszponzív újraszámolás ablak átméretezéskor ---
            $(window).on('resize', function () {
                table.columns.adjust().responsive.recalc();
            });
        });
    </script>
{% endblock scripts %}
